<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>VR Shooter Game</title>
    <!-- Include A-Frame library for WebXR support -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <!-- A-Frame scene containing the world and all entities -->
    <a-scene>
      <!-- Ground plane -->
      <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>
      <!-- Sky -->
      <a-sky color="#ECECEC"></a-sky>
      <!-- Manager to handle spawning targets -->
      <a-entity id="game-manager"></a-entity>
      <!-- Player with camera; gun attached as a child -->
      <a-entity id="player" camera wasd-controls look-controls position="0 1.6 0">
        <a-entity id="gun" position="0 -0.3 -0.5">
          <!-- Simple low‑poly revolver using primitive shapes -->
          <a-box position="-0.05 0 -0.05" depth="0.1" height="0.2" width="0.1" color="#4A4A4A"></a-box>
          <a-cylinder radius="0.03" height="0.4" position="0.1 0 0" rotation="0 0 90" color="#777777"></a-cylinder>
        </a-entity>
      </a-entity>

      <script>
        /*
         * This script adds dynamic gameplay elements: a simple low‑poly revolver held
         * by the player, randomly spawning spheres in front of the player, and a
         * shooting mechanism. Clicking shoots a bullet in the direction the
         * player is facing. Bullets destroy spheres upon collision.
         */
        
        // Component responsible for spawning spheres (targets) in front of the player
        AFRAME.registerComponent('game-manager', {
          init: function () {
            const scene = this.el.sceneEl;
            const spawnSphere = () => {
              const sphere = document.createElement('a-sphere');
              sphere.classList.add('targetSphere');
              sphere.setAttribute('radius', '0.2');
              sphere.setAttribute('color', '#FFC65D');
              // Determine spawn position relative to player
              const cam = document.querySelector('#player');
              const dir = new THREE.Vector3();
              cam.object3D.getWorldDirection(dir);
              const pos = cam.object3D.position.clone();
              // Random lateral offsets so spheres aren't always centered
              const lateral = new THREE.Vector3(
                (Math.random() - 0.5) * 2,      // x offset between -1 and 1
                Math.random() * 2,              // y offset between 0 and 2
                0
              );
              // Forward distance between 3 and 6 units
              const forwardDist = 3 + Math.random() * 3;
              const forward = dir.clone().normalize().multiplyScalar(forwardDist);
              const spawnPos = pos.clone().add(forward).add(lateral);
              sphere.setAttribute('position', `${spawnPos.x} ${spawnPos.y} ${spawnPos.z}`);
              scene.appendChild(sphere);
            };
            // Spawn an initial target and set up a recurring spawn interval
            spawnSphere();
            this.spawnInterval = setInterval(spawnSphere, 3000);
          },
          remove: function () {
            clearInterval(this.spawnInterval);
          }
        });

        // Component attached to the gun for shooting bullets
        AFRAME.registerComponent('gun-shooter', {
          init: function () {
            const scene = this.el.sceneEl;
            this.shoot = () => {
              const bullet = document.createElement('a-sphere');
              bullet.setAttribute('radius', '0.05');
              bullet.setAttribute('color', '#FAD02C');
              const cam = document.querySelector('#player');
              const dir = new THREE.Vector3();
              cam.object3D.getWorldDirection(dir);
              const startPos = cam.object3D.position
                .clone()
                .add(dir.clone().multiplyScalar(0.5));
              bullet.setAttribute('position', `${startPos.x} ${startPos.y} ${startPos.z}`);
              bullet.setAttribute('bullet', { direction: `${dir.x} ${dir.y} ${dir.z}` });
              scene.appendChild(bullet);
            };
            // Shoot when the user clicks anywhere on the screen
            window.addEventListener('click', this.shoot);
          },
          remove: function () {
            window.removeEventListener('click', this.shoot);
          }
        });

        // Component controlling bullet movement and collision detection
        AFRAME.registerComponent('bullet', {
          schema: {
            direction: { type: 'vec3' },
            speed: { type: 'number', default: 5 }
          },
          tick: function (time, timeDelta) {
            // Move bullet in its specified direction
            const dirVec = new THREE.Vector3(this.data.direction.x, this.data.direction.y, this.data.direction.z)
              .clone()
              .normalize()
              .multiplyScalar(this.data.speed * timeDelta / 1000);
            this.el.object3D.position.add(dirVec);
            // Check collisions with target spheres
            const bulletPos = this.el.object3D.position;
            const spheres = document.querySelectorAll('.targetSphere');
            for (let i = 0; i < spheres.length; i++) {
              const s = spheres[i];
              const sPos = s.object3D.position;
              const dist = bulletPos.distanceTo(sPos);
              const radiusSum = 0.05 + parseFloat(s.getAttribute('radius'));
              if (dist < radiusSum) {
                // Remove sphere and bullet upon collision
                if (s.parentNode) s.parentNode.removeChild(s);
                if (this.el.parentNode) this.el.parentNode.removeChild(this.el);
                return;
              }
            }
            // Remove bullet if it travels too far
            if (this.el.object3D.position.length() > 50) {
              if (this.el.parentNode) this.el.parentNode.removeChild(this.el);
            }
          }
        });

        // Initialise game components after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelector('#game-manager').setAttribute('game-manager', '');
          document.querySelector('#gun').setAttribute('gun-shooter', '');
        });
      </script>
    </a-scene>
  </body>
</html>
